import { useState, useEffect } from 'react';
import ReactECharts from 'echarts-for-react';
import 'echarts-gl'; // Import for 3D charts
import {
  BarChartConfig,
  LineChartConfig,
  PieChartConfig,
  HorizontalBarChartConfig,
  BoxPlotChartConfig,
  EffectScatterChartConfig,
  SmoothLineChartConfig,
  AreaChartConfig,
  FunnelChartConfig,
  GaugeChartConfig,
  HeatmapChartConfig,
  LiquidChartConfig,
  RadarChartConfig,
  CandlestickChartConfig,
  WordCloudChartConfig,
  ParallelChartConfig,
  BubbleChartConfig,
  GraphChartConfig,
  Line3DChartConfig,
  Bar3DChartConfig,
  Scatter3DChartConfig,
  Surface3DChartConfig,
  ThemeRiverChartConfig,
  SankeyChartConfig,
  GeoChartConfig,
  MapChartConfig,
  TreemapChartConfig,
  CalendarHeatmapChartConfig,
  ViolinPlotChartConfig,
  StackedBarChartConfig,
  PolarBarChartConfig,
  GanttChartConfig
} from './ChartConfigs';

interface ChartConfigModalProps {
  isOpen: boolean;
  onClose: () => void;
  chartType: string;
  sheetData: { headers: string[]; rows: string[][] } | null;
  onSave: (config: any) => void;
}

export function ChartConfigModal({ isOpen, onClose, chartType, sheetData, onSave }: ChartConfigModalProps) {
  const [chartConfig, setChartConfig] = useState<any>(null);

  useEffect(() => {
    if (!isOpen) {
      setChartConfig(null);
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handlePreviewChange = (config: any) => {
    setChartConfig(config);
  };

  const handleSave = () => {
    if (chartConfig) {
      onSave(chartConfig);
      onClose();
    }
  };

  const renderConfigComponent = () => {
    switch (chartType) {
      case 'bar':
        return <BarChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'line':
        return <LineChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'pie':
        return <PieChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'horizontalBar':
        return <HorizontalBarChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'boxplot':
        return <BoxPlotChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'effectScatter':
        return <EffectScatterChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'smoothLine':
        return <SmoothLineChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'area':
        return <AreaChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'funnel':
        return <FunnelChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'gauge':
        return <GaugeChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'heatmap':
        return <HeatmapChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'liquid':
        return <LiquidChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'radar':
        return <RadarChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'candlestick':
        return <CandlestickChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'wordcloud':
        return <WordCloudChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'parallel':
        return <ParallelChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'bubble':
        return <BubbleChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'graph':
        return <GraphChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'line3d':
        return <Line3DChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'bar3d':
        return <Bar3DChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'scatter3d':
        return <Scatter3DChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'surface3d':
        return <Surface3DChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'themeRiver':
        return <ThemeRiverChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'sankey':
        return <SankeyChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'geo':
        return <GeoChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'map':
        return <MapChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'treemap':
        return <TreemapChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'calendarHeatmap':
        return <CalendarHeatmapChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'violin':
        return <ViolinPlotChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'stackedBar':
        return <StackedBarChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'polarBar':
        return <PolarBarChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      case 'gantt':
        return <GanttChartConfig sheetData={sheetData} onPreviewChange={handlePreviewChange} />;
      default:
        return (
          <div className="text-center py-8">
            <p className="text-gray-500">Configuration for {chartType} coming soon...</p>
          </div>
        );
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <h2 className="text-xl font-semibold text-gray-900">
            Configure Chart: {chartType}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-hidden flex">
          {/* Left Panel - Configuration */}
          <div className="w-1/3 border-r border-gray-200 p-6 overflow-y-auto">
            {renderConfigComponent()}
          </div>

          {/* Right Panel - Preview */}
          <div className="flex-1 p-6 overflow-y-auto bg-gray-50">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">Preview</h3>
            {chartConfig ? (
              <div className="bg-white rounded-lg shadow-sm p-4 h-[500px]">
                <ReactECharts
                  option={chartConfig}
                  style={{ height: '100%', width: '100%' }}
                  opts={{ renderer: 'canvas' }}
                />
              </div>
            ) : (
              <div className="bg-white rounded-lg shadow-sm p-4 h-[500px] flex items-center justify-center">
                <p className="text-gray-400">Configure chart to see preview</p>
              </div>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-gray-200 flex items-center justify-end space-x-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            disabled={!chartConfig}
            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Add to Dashboard
          </button>
        </div>
      </div>
    </div>
  );
}
